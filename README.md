# 住所検索プログラム

## 概要
このプログラムは、指定された単語を使用して住所を検索し、その単語の文字列と一致する住所の一覧を返します。高速な検索を実現するために、2-gramを使用した転置インデックスを作成し、そのインデックスに対して検索を行います。

## 必要条件
- Ruby 2.7以上
- Bundler

## セットアップ
1. このリポジトリをクローンします。
2. プロジェクトディレクトリに移動します。
3. 以下のコマンドを実行して必要な依存関係をインストールします：
   ```bash
   bundle install
   ```
   注意：`.bundler/config`ファイルにより、gemは`vendor/bundle`ディレクトリにインストールされます。

## 使用方法

### 設定
プログラムを実行する前に、`config.json`ファイルを作成し、必要な設定を行ってください。以下は設定例です：

```json
{
  "default": {
    "csv_path": "path/to/address.csv",
    "index_path": "path/to/index.msgpack",
    "addresses_path": "path/to/addresses.msgpack",
    "encoding": "UTF-8"
  }
}
```

### インデックスの構築
まず、住所データのインデックスを構築する必要があります。以下のコマンドを使用します：

```bash
bundle exec ruby main.rb --build
```

CSVファイルのパスを指定する場合：

```bash
bundle exec ruby main.rb --build --csv_path path/to/address.csv
```

### 住所の検索
インデックスを構築した後、以下のコマンドで住所を検索できます：

```bash
bundle exec ruby main.rb --search "東矢口"
```

### ユニットテストの実行
以下のコマンドでユニットテストを実行できます：

```bash
bundle exec ruby test_address_search.rb
```

## 設計説明

### アルゴリズムの選択と実装詳細
このプログラムでは、高速な検索を実現するために以下の技術を採用しました：

1. 2-gram (バイグラム):
    - 実装: `AddressSearcher#generate_2grams` メソッドで実装。
    - 処理: 入力文字列を正規化し、連続する2文字ずつの部分文字列を生成。
    - 利点: 日本語の住所表記に対して効果的な検索が可能。単語の境界に依存しない。
    - 例: "東京都" → ["東京", "京都"]

2. 転置インデックス:
    - 実装: `AddressSearcher#build_inverted_index` メソッドで構築。
    - 構造: Hash オブジェクトを使用。キーは2-gramトークン、値は該当する住所のインデックスの配列。
    - 処理: 各住所の全フィールド（郵便番号以外）から2-gramを生成し、インデックスを構築。
    - 最適化: Set を使用して重複を除去し、最終的に配列に変換。
    - 利点: 検索時間を O(n) から O(1) に短縮（n は住所データの総数）。

### データ構造

1. AddressData:
    - 目的: 各住所のデータを効率的に保持し、検索結果を整形。
    - フィールド: 郵便番号、都道府県、市区町村、町域、京都通り名、字丁目、事業所名、事業所住所。
    - メソッド:
        - `full_address`: 全フィールドを連結して完全な住所文字列を生成。
        - `formatted_output`: 検索結果の出力形式を生成。

2. 転置インデックス:
    - 構造: `{ 2gram_token => [address_index1, address_index2, ...] }`
    - メモリ効率: 住所データそのものではなく、インデックスのみを保持。

### 処理フロー詳細

1. インデックス構築 (`build_index` メソッド):
    - CSV読み込み: `load_csv` メソッドで住所データを AddressData オブジェクトの配列に変換。
    - インデックス生成: 各 AddressData オブジェクトの全フィールドから2-gramを生成。
    - インデックス構築: 各2-gramをキーとし、対応する住所のインデックスを値とする Hash を作成。
    - 永続化: MessagePack を使用してインデックスと住所データをシリアライズし、ファイルに保存。

2. 検索処理 (`search` メソッド):
    - クエリ処理: 入力クエリから2-gramを生成。
    - インデックス参照: 各2-gramに対応する住所インデックスを取得。
    - 結果絞り込み: すべての2-gramを含む住所のみを結果として抽出。
    - ランキング: 完全一致度に基づいて結果をソート。

### 最適化技術

1. 文字列正規化:
    - 実装: `AddressSearcher#normalize` メソッド。
    - 処理: Unicode正規化（NFKC）、小文字化、カタカナのひらがな化。
    - 目的: 表記ゆれによる検索漏れを防止。

2. インデックスの圧縮と高速化:
    - 重複除去: Set を使用して一時的に重複を排除。
    - シリアライズ: MessagePack を使用してバイナリ形式で保存、読み込み時間とディスクスペースを節約。

3. メモリ使用量の最適化:
    - 住所データの間接参照: インデックスには住所データそのものではなく、インデックス番号のみを保持。
    - 遅延評価: `full_address` メソッドで `@full_address` をメモ化し、必要時のみ生成。

4. 検索アルゴリズムの効率化:
    - セット演算: クエリの全2-gramに対応する住所インデックスの積集合を取ることで高速に結果を絞り込み。
    - 早期リターン: マッチする2-gramが1つもない場合、即座に空の結果を返す。

### パフォーマンス特性
- インデックス構築: O(N * M)、N は住所の総数、M は各住所の平均文字数。
- 検索: O(K + R)、K はクエリから生成される2-gramの数、R は結果の数。
- 空間計算量: O(N * L)、L は各住所から生成される一意な2-gramの平均数。

これらの設計と最適化により、大規模な住所データセットに対しても高速な検索が可能となっています。

## パフォーマンスの考慮
- **MessagePack**を使用してインデックスと住所データをシリアライズしています。これにより、ディスクI/Oとメモリ使用量を最適化しています。
- 検索時に中間結果のセット演算を行うことで、高速な絞り込みを実現しています。

## エラー処理とログ
- **Logger**を使用して、処理の進行状況やエラーを記録します。
- ファイルの存在チェックや入力値の検証を行い、エラーを適切に処理します。

## 依存関係
プロジェクトの`Gemfile`には以下のgemが含まれています：

```ruby
source 'https://rubygems.org'

gem 'csv'
gem 'json'
gem 'msgpack'
gem 'oj'
gem 'minitest'
gem 'nkf'
gem 'moji'

group :development, :test do
  gem 'bundler'
  gem 'test-unit'
end

Bundler.settings.set_local(:path, 'vendor/bundle')
```

これらのgemは、CSVの処理、JSONの取り扱い、MessagePackによるシリアライズ、文字列の正規化などの機能を提供します。

## 注意事項
- 大規模なデータセットを扱う場合は、十分なメモリを確保してください。
- インデックスの構築には時間がかかる場合があります。十分な時間的余裕を持って実行してください。
- 住所データのCSVファイルは、このリポジトリにはコミットしていません。別途入手する必要があります。

このプログラムは「住所.jp」の「全国」のCSVデータを想定しています。他の形式のデータを使用する場合は、`load_csv`メソッドを適切に修正してください。

## トラブルシューティング
- インデックス構築時にメモリエラーが発生する場合は、システムの仮想メモリを増やすか、より小さなデータセットで試してください。
- 検索結果が期待通りでない場合は、入力データの文字エンコーディングが正しいか確認してください。

## 今後の改善点
- マルチスレッド処理の導入によるインデックス構築の高速化
- インクリメンタル更新機能の追加
- Web APIの実装

## ライセンス
このプロジェクトはGPL-2.0ライセンスの下で公開されています。